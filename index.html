<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOR Pi MAXIMUM TRANSACTION Demo (SDK MOCKED)</title>
    <script src="https://cdn.tailwindcss.com"></script> 
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <script src="https://sdk.minepi.com/pi-sdk-client.js"></script> 

    <style>
        /* CSS Styles */
        body {
            font-family: sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
            padding: 2rem 1rem;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .header {
            background-color: #1f2937;
            color: white;
            padding: 2rem;
            border-radius: 1rem;
        }
        .simulator-section {
            background: white;
            padding: 2rem;
            margin: 2rem 0 0 0; 
            border-radius: 1rem 1rem 0 0;
            box-shadow: 0 2px 15px -5px rgba(0, 0, 0, 0.1);
        }
        .inflation-chart {
            height: 300px;
            background: white;
            padding: 1rem;
            margin: 2rem 0;
            border-radius: 1rem;
            box-shadow: 0 2px 15px -5px rgba(0, 0, 0, 0.1);
        }
        /* Real-time Block Explorer iframe style */
        #block_explorer_iframe {
            width: 100%;
            height: 150px; 
            border: 2px solid #e5e7eb;
            border-top: none;
            border-radius: 0 0 1rem 1rem;
            display: block;
            margin-bottom: 2rem; 
        }
        /* SCP Consensus Animation Style */
        .scp-consensus {
            font-size: 0.8rem; 
            font-weight: bold;
            color: white; 
            background: #4f46e5; 
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            white-space: nowrap;
            opacity: 0; 
            transition: opacity 0.3s;
            margin-left: 1rem; 
        }
        /* Ledger header container for flex */
        .ledger-header-container {
            display: flex;
            align-items: center;
            margin-bottom: 1rem;
        }
        /* Download button style */
        .download-button {
            background-color: #10b981; 
            color: white;
            padding: 0.3rem 0.6rem;
            border-radius: 0.5rem;
            font-size: 0.8rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            margin-left: auto; 
            transition: background-color 0.2s;
        }
        .download-button:hover {
            background-color: #059669;
        }
        /* Login and Payment Button Styles */
        .pi-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            cursor: pointer;
            border: none;
            transition: background-color 0.2s;
            width: 100%;
            margin-bottom: 1rem;
        }
        .login-button {
            background-color: #f7a43b; /* Pi Yellow */
            color: white;
        }
        .login-button:hover {
            background-color: #e09133;
        }
        .payment-button {
            background-color: #4CAF50; /* Green */
            color: white;
        }
        .payment-button:hover {
            background-color: #45A049;
        }
        /* Input and Select styling for better visibility */
        input[type="number"], select {
            width: 100%;
            padding: 0.5rem;
            margin-top: 0.25rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
        }
        /* Style for Public Key cell to ensure readability (Í∏ÄÍº¥ ÌÅ¨Í∏∞ Ï∂ïÏÜå Î∞òÏòÅ) */
        .pk-cell {
            font-family: monospace;
            font-size: 0.65rem; 
        }
        .grid {
            display: grid;
        }
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .gap-4 {
            gap: 1rem;
        }
    </style>
</head>
<body>

    <div id="message_box" style="z-index: 1000; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%) scale(0); transition: transform 0.3s; padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; background-color: #1f2937;">
        App Status: Ready
    </div>

    <div class="container">
        <div class="header rounded-xl p-6 md:p-8 flex flex-col md:flex-row items-center justify-between mb-8">
            <div class="flex-1">
                <p class="text-white text-lg font-semibold mb-2">FOR Pi MAXIMUM TRANSACTION</p>
                <p class="text-gray-400 font-bold mb-4">Monitor real-time transactions and delegated AI activities based on your inputs.</p>
            </div>
            <div class="md:ml-8 mt-4 md:mt-0">
                <p class="text-white text-sm font-bold text-center">Run simulation via the buttons below.</p>
            </div>
        </div>

        <div class="simulator-section">
            <h2 class="text-2xl font-bold mb-4">Transaction Delegation Simulation (SDK MOCKED)</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <button id="login_button" class="pi-button login-button" onclick="piAuthenticate()">
                    1. Pi Login (Identify User - MOCKED)
                </button>
                <button id="payment_button" class="pi-button payment-button" onclick="piRequestPayment()" disabled>
                    2. Request Pi Payment (Start SC - MOCKED)
                </button>
            </div>
            
            <div class="grid grid-cols-2 gap-4">
                <div>
                    <label htmlFor="piAmount">Pi Amount (for SC Selection):</label>
                    <input type="number" id="piAmount" step="0.0001" value="0.0101" placeholder="e.g. 2.5">
                </div>
                <div>
                    <label htmlFor="taskType">Task Type:</label>
                    <select id="taskType">
                        <option value="Drawing">Ï∞ΩÏûë: Í∑∏Î¶º (Drawing)</option>
                        <option value="Animation">Ï∞ΩÏûë: Ïï†ÎãàÎ©îÏù¥ÏÖò (Animation)</option>
                        <option value="VideoEdit">Ï∞ΩÏûë: ÎèôÏòÅÏÉÅ Ìé∏Ïßë (Video Edit)</option>
                        <option value="Research">Îç∞Ïù¥ÌÑ∞: Î¶¨ÏÑúÏπò/Î∂ÑÏÑù (Research/Analysis)</option>
                    </select>
                </div>
            </div>
        </div>

        <iframe id="block_explorer_iframe" 
                src="https://blockexplorer.minepi.com/testnet/" 
                title="Pi Testnet Block Explorer" 
                frameborder="0"
                allow="autoplay; encrypted-media"></iframe>

        <div id="inflation_chart" class="inflation-chart">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-bold text-gray-700">Pi Economy Inflation Index (Simulated)</h3>
                <span id="public_tax_display" class="text-base font-bold text-green-600">Public Tax Pool: 0.0000 Pi</span>
            </div>
        </div>

        <div class="table-container p-6 mb-8 relative bg-white rounded-xl shadow-lg"> 
            
            <div class="ledger-header-container">
                <h2 class="text-2xl font-bold text-gray-800">TRANSACTION LEDGER (Off-Chain/Logical)</h2>
                
                <button class="download-button" onclick="downloadLedger()">Download CSV</button>

                <div id="scp_consensus_status" class="scp-consensus" style="opacity: 0;">SCP Consensus: 0/10001 Nodes</div>
            </div>

            <table class="min-w-full divide-y divide-gray-200" id="ledger_table">
                <thead>
                    <tr class="bg-gray-50">
                        <th class="px-2 py-2 text-xs">ID</th>
                        <th class="px-2 py-2 text-xs">Time</th>
                        <th class="px-2 py-2 text-xs">Sender</th>
                        <th class="px-2 py-2 text-xs">Smart Contract</th>
                        <th class="px-2 py-2 text-xs">Pi Amount</th>
                        <th class="px-2 py-2 text-xs">Task</th>
                        <th class="px-2 py-2 text-xs">SC Code</th>
                    </tr>
                </thead>
                <tbody id="smart_contract_ledger">
                    </tbody>
            </table>
        </div>

    </div>

    <script>
        // üåüüåüüåü 2. Pi SDK Ï¥àÍ∏∞Ìôî (Ï∂îÍ∞ÄÎê®) üåüüåüüåü
        // Pi Developer Portal (Testnet App Settings)ÏóêÏÑú Client IDÎ•º ÌôïÏù∏ÌïòÏÑ∏Ïöî!
        Pi.init({
            version: "2.0",
            client_id: "[Ïó¨Í∏∞Ïóê ÎãπÏã†Ïùò Ïã§Ï†ú Pi Client IDÎ•º ÎÑ£ÏúºÏÑ∏Ïöî]", 
            redirect_uri: "https://jjulddugi65.github.io/pimaxtx", 
            sandbox: true, 
            app_name: "pimaxtx"
        });

        // === Core Variables ===
        let transactionID = 18; // ÎßàÏßÄÎßâ ID Ïù¥ÌõÑÎ∂ÄÌÑ∞ ÏãúÏûë
        const maxNodes = 10001;
        let authenticatedUser = null; 
        
        // Public KeyÍ∞Ä Ìè¨Ìï®Îêú Î™®Ïùò ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ ÏÑ§Ï†ï (KYC ID + Ï§ÑÏù∏ Public Key)
        const MOCK_PUBLIC_KEY_SHORT = 'GDUVQR...QO6'; 
        const KYC_ID = '10821'; 
        const mockUsername = KYC_ID + '_' + MOCK_PUBLIC_KEY_SHORT; // ÏµúÏ¢Ö Ïû•Î∂Ä ÌëúÍ∏∞

        // --- Public Tax (Í≥µÍ≥µÏÑ∏) & Economy Variables ---
        const PUBLIC_TAX_RATE = 0.01; // 1% Public Tax (0.01)
        const FIXED_FEE = 0.01; // Í≥†Ï†ï ÏàòÏàòÎ£å (0.01 Pi)
        let publicTaxPool = 0.0; // ÎàÑÏ†Å Í≥µÍ≥µÏÑ∏ ÌíÄ (Ìï©Í≥ÑÏï°)
        // ----------------------------------------------------

        // --- Utility Functions ---

        function showMessage(message, isSuccess = true) {
            const messageBox = document.getElementById('message_box');
            if (!messageBox) return; 

            messageBox.textContent = message;
            messageBox.style.opacity = 1;
            messageBox.style.transform = 'translateX(-50%) scale(1)';
            
            // Re-apply classes for styling
            messageBox.classList.remove('bg-green-600', 'bg-red-600', 'bg-gray-800');
            if (isSuccess) {
                messageBox.style.backgroundColor = '#4CAF50'; /* Green */
            } else {
                messageBox.style.backgroundColor = '#F44336'; /* Red */
            }
            
            setTimeout(() => {
                messageBox.style.transform = 'translateX(-50%) scale(0)';
            }, 3000);
        }

        // Fix 1: Í≥µÍ≥µÏÑ∏ ÌíÄ ÎîîÏä§ÌîåÎ†àÏù¥ ÏóÖÎç∞Ïù¥Ìä∏ (ÎàÑÏ†Å Ìï©Í≥Ñ ÌëúÏãú)
        function updatePublicTaxDisplay() {
            const taxElement = document.getElementById('public_tax_display');
            if (taxElement) {
                // publicTaxPoolÏùÄ runSimulationÏóêÏÑú Í≥ÑÏÜç ÎàÑÏ†ÅÎê©ÎãàÎã§.
                taxElement.textContent = `Public Tax Pool: ${publicTaxPool.toFixed(4)} Pi`;
            }
        }

        // SCP Consensus Animation Simulation
        function startSCPAnimation(scType) {
            const scpStatusElement = document.getElementById('scp_consensus_status');
            if (!scpStatusElement) return;

            scpStatusElement.style.opacity = 1;

            const consensusSteps = [31, 314, 3141, maxNodes]; 
            let stepIndex = 0;
            
            showMessage(`AI selected ${scType}. Starting MOCKED SCP Consensus...`, true); 

            const interval = setInterval(() => {
                const currentCount = consensusSteps[stepIndex];
                scpStatusElement.textContent = `SCP Consensus: ${currentCount}/${maxNodes} Nodes`;
                
                stepIndex++;
                if (stepIndex >= consensusSteps.length) {
                    clearInterval(interval);
                    scpStatusElement.textContent = `SCP Consensus: 10001/${maxNodes} Nodes (Finalized)`;
                }
            }, 500); 
        }
        
        // --- MOCKED Pi SDK Functions ---
        
        // 1. MOCKED Pi Authentication (Login)
        function piAuthenticate() {
            // üåüüåüüåü Pi.authenticate() Ïã§Ï†ú Ìò∏Ï∂úÎ°ú Î≥ÄÍ≤Ω üåüüåüüåü
            Pi.authenticate(['username'], onIncompletePaymentFound)
                .then(function(auth) {
                    authenticatedUser = auth.user.username; // Ïã§Ï†ú ÏÇ¨Ïö©Ïûê Ïù¥Î¶Ñ ÏÇ¨Ïö©
                    showMessage(`Pi ID: ${authenticatedUser} authenticated successfully!`, true);
                    document.getElementById('login_button').disabled = true;
                    document.getElementById('payment_button').disabled = false;
                })
                .catch(function(error) {
                    showMessage(`Authentication failed: ${error.message}`, false);
                });
        }
        
        // Incomplete Payment Handler (ÌïÑÏöîÏãú Íµ¨ÌòÑ)
        function onIncompletePaymentFound(payment) {
            showMessage(`Incomplete payment found! ID: ${payment.identifier}`, false);
        }

        // 2. MOCKED Pi Payment Request
        function piRequestPayment() {
            if (!authenticatedUser) {
                showMessage("Please log in with Pi first.", false);
                return;
            }

            const amount = parseFloat(document.getElementById('piAmount').value);
            const taskType = document.getElementById('taskType').value; 

            if (isNaN(amount) || amount <= 0) {
                 showMessage("Please enter a valid Pi Amount.", false);
                 return;
            }

            // ÏÇ¨Ïö©Ïûê ÏöîÏ≤≠ Î∞òÏòÅ: 0.0101/n Î°úÏßÅÏóê Îî∞Îùº 0.0101 PiÎ•º ÏµúÏÜå Í±∞Îûò Í∏àÏï°ÏúºÎ°ú ÏÑ§Ï†ï
            const minRequiredAmount = 0.0101; 
            
            if (amount < minRequiredAmount) { 
                showMessage(`Pi Amount must be greater than or equal to ${minRequiredAmount.toFixed(4)} Pi (0.0101/n logic).`, false);
                return;
            }

            // MOCKED Payment Request Î°úÏßÅÏùÄ Í∑∏ÎåÄÎ°ú Ïú†ÏßÄÌïòÏó¨ ÏãúÏó∞
            showMessage(`MOCKED Payment request ($${amount.toFixed(4)}$ Pi) sent. Starting SC execution...`, true);
            runSimulation(taskType); 
        }
        
        // --- Simulation & Core Logic (Called upon successful payment) ---
        function runSimulation(taskType) {
            const piAmountInput = document.getElementById('piAmount').value;
            const amount = parseFloat(piAmountInput);
            
            // --- 1. Í≤ΩÏ†ú Î°úÏßÅ: ÏûëÏóÖ ÎπÑÏö© (W), Í≥µÍ≥µÏÑ∏ (P), Í≥†Ï†ï ÏàòÏàòÎ£å (F) Ïó≠ÏÇ∞ ---
            // W = (A - F) / (1 + T)
            const workCost = (amount - FIXED_FEE) / (1 + PUBLIC_TAX_RATE);
            
            // Í≥µÍ≥µÏÑ∏ Í≥ÑÏÇ∞: ÏßïÏàò
            const publicTax = workCost * PUBLIC_TAX_RATE;
            
            // Í≥µÍ≥µÏÑ∏ ÌíÄÏóê ÎàÑÏ†Å Ìï©Í≥Ñ Ï†ÅÎ¶Ω Î∞è ÏóÖÎç∞Ïù¥Ìä∏
            publicTaxPool += publicTax;
            updatePublicTaxDisplay(); 
            // ------------------------------------------------------------------


            // 2. Smart Contract Selection (Work Cost Í∏∞Ï§ÄÏúºÎ°ú 1st/2nd SC ÏÑ†ÌÉù)
            let scType = workCost >= 2.0 ? '2nd SC (Market)' : '1st SC (Survival)';

            startSCPAnimation(scType); 

            const ledger = document.getElementById('smart_contract_ledger');
            
            // Main Transaction ID
            transactionID++;
            const mainID = transactionID;
            
            // AIÏóêÍ≤å Î∂ÑÎ∞∞ÎêòÎäî ÏàúÏàò ÏûëÏóÖ ÎπÑÏö© (Work Cost)ÏùÑ AI1Í≥º AI2ÏóêÍ≤å Ï†àÎ∞òÏî© Î∂ÑÌï†
            const subAmountNet = (workCost / 2.0).toFixed(5);
            // ÏÇ¨Ïö©Ïûê Ïù¥Î¶ÑÏùÄ Ïã§Ï†ú Pi Ïù∏Ï¶ù ÌõÑ Î∞õÏùÄ authenticatedUser ÏÇ¨Ïö© (Î™®Ïùò ÌôòÍ≤Ω ÎåÄÎπÑ)
            const senderName = authenticatedUser ? authenticatedUser : KYC_ID + '_...QO6'; 
            const currentTime = new Date().toLocaleTimeString();

            // AI ÏûëÏóÖ Í≤∞Í≥º ÏãúÎÆ¨Î†àÏù¥ÏÖò: 90% ÏÑ±Í≥µ, 10% Ïã§Ìå®
            const getAIResult = () => (Math.random() < 0.9) ? 'SUCCESS' : 'FAILURE';
            const subResult1 = getAIResult();
            const subResult2 = getAIResult();
            
            // 3. Main Transaction (User calling the SC) - Total Amount
            
            // Î°úÏßÅ Î™ÖÏãúÎ•º ÏúÑÌï¥ scTypeÏùÑ Ïû¨ÏÑ§Ï†ï (ÏÇ¨Ïö©Ïûê ÌîºÎìúÎ∞± Î∞òÏòÅ)
            let scDisplay = scType;
            if (scType.includes('1st SC')) {
                scDisplay = '1st SC (0.0101/n)';
            }
            
            let newRowMain = ledger.insertRow();
            newRowMain.innerHTML = `
                <td class="px-2 py-2 text-xs font-bold">${mainID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs font-bold pk-cell">${senderName} (Main T1)</td>
                <td class="px-2 py-2 text-xs">${scDisplay}</td> 
                <td class="px-2 py-2 text-xs font-bold">${amount.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">${taskType}</td> 
                <td class="px-2 py-2 text-xs">CALLED</td>
            `;

            // 4. Ledger Entry: Fixed Fee ÏßïÏàò Í∏∞Î°ù (Creator ÏßÄÎ∂à)
            transactionID++; 
            let newRowFee = ledger.insertRow();
            newRowFee.innerHTML = `
                <td class="px-2 py-2 text-xs">${transactionID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs">SYSTEM (Fee T2)</td>
                <td class="px-2 py-2 text-xs font-bold text-red-700">FIXED FEE (0.01)</td>
                <td class="px-2 py-2 text-xs font-bold text-red-700">-${FIXED_FEE.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">Network Op</td>
                <td class="px-2 py-2 text-xs">COLLECTED</td>
            `;
            
            // 5. Ledger Entry: Public Tax ÏßïÏàò Í∏∞Î°ù (Creator ÏßÄÎ∂à)
            transactionID++; 
            let newRowTax = ledger.insertRow();
            newRowTax.innerHTML = `
                <td class="px-2 py-2 text-xs">${transactionID}</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs">SYSTEM (Tax T3)</td>
                <td class="px-2 py-2 text-xs font-bold text-red-600">PUBLIC TAX (1%)</td>
                <td class="px-2 py-2 text-xs font-bold text-red-600">-${publicTax.toFixed(4)}</td>
                <td class="px-2 py-2 text-xs">Public Fund</td>
                <td class="px-2 py-2 text-xs">COLLECTED</td>
            `;
            
            // 6. Sub Transaction 1 (AI1 Activity & Net Amount Distribution) - Fix 2 Ï†ÅÏö©: Ïã§Ìå® Ïãú Îπ®Í∞ÑÏÉâ ÌëúÏãú
            let newRow1 = ledger.insertRow();
            newRow1.innerHTML = `
                <td class="px-2 py-2 text-xs">${mainID}-01</td>
                <td class="px-2 py-2 text-xs">${currentTime}</td>
                <td class="px-2 py-2 text-xs">AI1 (1/2 Net T4)</td>
                <td class="px-2 py-2 text-xs">${scType} Process</td>
                <td class="px-2 py-2 text-xs font-bold text-green-600">+${subAmountNet}</td>
                <td class="px-2 py-2 text-xs">${taskType} Process</td>
                <td class="px-2 py-2 text-xs font-bold ${subResult1 === 'FAILURE' ? 'text-red-600' : 'text-indigo-600'}">${subResult1}</td>
            `;
            
            // 7. Sub Transaction 2 (AI2 Activity & Net Amount Distribution) - Fix 2 Ï†ÅÏö©: Ïã§Ìå® Ïãú Îπ®Í∞ÑÏÉâ ÌëúÏãú Î∞è Í∏àÏï° ÌëúÏãú ÌÜµÏùº
            let newRow2 = ledger.insertRow();
            newRow2.innerHTML = `
                <td class="px-2 py-2 text-xs">${main
