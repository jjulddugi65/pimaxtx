<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FOR Pi MAXIMUM TRANSACTION - DEMO VERSION (Chrome Ready)</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://d3js.org/d3.v7.min.js"></script>

    <style>
        body {
            font-family: sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        .container {
            max-width: 1200px;
            margin: auto;
        }
        .header {
            background-color: #5b21b6;
            color: white;
        }
        .pi-button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: bold;
            color: white;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .login-button {
            background-color: #fca5a5;
        }
        .login-button:hover:not(:disabled) {
            background-color: #f87171;
        }
        .payment-button {
            background-color: #34d399;
        }
        .payment-button:hover:not(:disabled) {
            background-color: #10b981;
        }
        .payment-button:disabled, .login-button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        #block_explorer_iframe {
            width: 100%;
            height: 300px;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            margin-top: 1.5rem;
            margin-bottom: 1.5rem;
        }
        input[type="number"], select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            margin-top: 0.25rem;
        }
        /* SCP StatusëŠ” í…Œì´ë¸” ì»¨í…Œì´ë„ˆ ìš°ì¸¡ ìƒë‹¨ì— ì ˆëŒ€ ìœ„ì¹˜ë¡œ ê³ ì • */
        .scp-consensus {
            position: absolute;
            top: 0;
            right: 0;
            padding: 0.5rem 1rem;
            background-color: #5b21b6;
            color: white;
            border-bottom-left-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: bold;
            transition: opacity 0.5s;
        }
        .ledger-header-container {
            /* [ìˆ˜ì •] CSV ë²„íŠ¼ê³¼ ì œëª©ì„ ë¶„ë¦¬í•˜ì—¬ flexë¡œ ì •ë ¬ */
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
        }
        .download-button {
            background-color: #60a5fa;
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
            transition: background-color 0.2s;
            cursor: pointer;
            border: none;
        }
        .download-button:hover {
            background-color: #3b82f6;
        }
        #ledger_table {
            border-collapse: separate;
            border-spacing: 0;
            text-align: left;
            font-size: 0.875rem;
            width: 100%;
        }
        #ledger_table th, #ledger_table td {
            padding: 0.75rem 0.5rem;
            border-bottom: 1px solid #e5e7eb;
        }
        #ledger_table tr:last-child td {
            border-bottom: none;
        }
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.75rem;
            font-weight: bold;
        }
        .status-pending {
            background-color: #fef3c7;
            color: #92400e;
        }
        .status-success {
            background-color: #d1fae5;
            color: #065f46;
        }
        .status-failed {
            background-color: #fee2e2;
            color: #b91c1c;
        }
        .public-tax-display {
            background-color: #f59e0b; 
            color: white;
            padding: 0.5rem 1rem;
            border-radius: 0.5rem;
            font-size: 0.875rem;
            font-weight: bold;
            text-align: center;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: absolute; 
            top: 0;
            right: 0;
            margin-top: 1rem;
            margin-right: 1rem;
        }
    </style>
</head>
<body class="p-6 md:p-10">

    <div id="message_box" style="z-index: 1000; position: fixed; top: 1rem; left: 50%; transform: translateX(-50%) scale(0); transition: transform 0.3s; padding: 0.75rem 1.5rem; border-radius: 0.5rem; color: white; background-color: #1f2937;">
        App Status: Initializing...
    </div>

    <div class="container">
        <div class="header rounded-xl p-6 md:p-8 flex flex-col md:flex-row items-center justify-between mb-8">
            <div class="flex-1">
                <p class="text-white text-2xl font-bold mb-2">FOR Pi MAXIMUM TRANSACTION (DEMO MODE)</p>
                <p class="text-gray-300 text-sm mb-4">Monitor real-time transactions and delegated AI activities</p>
            </div>
            <div class="md:ml-8 mt-4 md:mt-0">
                <p id="sdk_status" class="text-yellow-300 text-sm font-bold text-center">MODE: DEMO (SDK DISABLED)</p>
            </div>
        </div>

        <div class="simulator-section bg-white p-6 rounded-xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold mb-4">Transaction Delegation Simulation</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <button id="login_button" class="pi-button login-button" onclick="piAuthenticate()">
                    ğŸ” 1. Pi Login (Simulated User: MaxUser)
                </button>
                <button id="payment_button" class="pi-button payment-button" onclick="piRequestPayment()" disabled>
                    ğŸ’° 2. Request Pi Payment (Start SC)
                </button>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div>
                    <label for="piAmount" class="font-medium text-gray-700">Pi Amount:</label>
                    <input type="number" id="piAmount" step="0.1" value="2.5" placeholder="e.g. 2.5">
                </div>
                <div>
                    <label for="taskType" class="font-medium text-gray-700">Task Type:</label>
                    <select id="taskType">
                        <option value="Drawing">ì°½ì‘: ê·¸ë¦¼ (Drawing)</option>
                        <option value="Animation">ì°½ì‘: ì• ë‹ˆë©”ì´ì…˜ (Animation)</option>
                        <option value="VideoEdit">ì°½ì‘: ë™ì˜ìƒ í¸ì§‘ (Video Edit)</option>
                        <option value="Research">ë°ì´í„°: ë¦¬ì„œì¹˜/ë¶„ì„ (Research)</option>
                    </select>
                </div>
            </div>
        </div>

        <iframe id="block_explorer_iframe" 
                src="https://blockexplorer.minepi.com/testnet/" 
                title="Pi Testnet Block Explorer" 
                frameborder="0"
                allow="autoplay; encrypted-media"></iframe>

        <div class="chart-section bg-white p-6 rounded-xl shadow-lg mb-8 relative">
            <h3 class="text-lg font-bold mb-2 text-gray-700">Pi Economy Inflation Index (Simulated)</h3>
            
            <div id="public_tax_total" class="public-tax-display">
                Public Tax Total: 0.00 Ï€
            </div>

            <div id="inflation_chart"></div>
        </div>

        <div class="table-container p-6 mb-8 relative bg-white rounded-xl shadow-lg">
            
            <div id="scp_consensus_status" class="scp-consensus" style="opacity: 0;">SCP Consensus: 0/10001 Nodes</div>
            
            <div class="ledger-header-container">
                <h2 class="text-2xl font-bold text-gray-800">TRANSACTION LEDGER</h2>
                <button class="download-button" onclick="downloadLedger()">ğŸ“¥ Download CSV</button> 
            </div>
            <div class="overflow-x-auto">
                <table id="ledger_table">
                    <thead>
                        <tr class="bg-gray-50">
                            <th>ID</th>
                            <th>Time</th>
                            <th>Sender</th>
                            <th>Smart Contract</th>
                            <th>Pi Amount</th>
                            <th>Task</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="smart_contract_ledger"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        // í•µì‹¬ ë³€ìˆ˜
        let transactionID = 0;
        const maxNodes = 10001;
        let authenticatedUser = null; 
        let publicTaxTotal = 0.0; // ê³µê³µì„¸ í•©ê³„ë¥¼ ì €ì¥í•  ì „ì—­ ë³€ìˆ˜
        
        // ë©”ì‹œì§€ í‘œì‹œ í•¨ìˆ˜
        function showMessage(message, isSuccess = true) {
            const messageBox = document.getElementById('message_box');
            if (!messageBox) return;

            messageBox.textContent = message;
            messageBox.style.backgroundColor = isSuccess ? '#10b981' : '#ef4444';
            messageBox.style.transform = 'translateX(-50%) scale(1)';
            
            setTimeout(() => {
                messageBox.style.transform = 'translateX(-50%) scale(0)';
            }, 3000);
        }

        // SCP í•©ì˜ ì• ë‹ˆë©”ì´ì…˜
        function startSCPAnimation(scType) {
            const scpStatusElement = document.getElementById('scp_consensus_status');
            if (!scpStatusElement) return;

            scpStatusElement.style.opacity = 1;
            const consensusSteps = [31, 314, 3141, maxNodes];
            let stepIndex = 0;

            showMessage(`AI selected ${scType}. Starting SCP Consensus...`, true);
            
            const interval = setInterval(() => {
                const currentCount = consensusSteps[stepIndex];
                scpStatusElement.textContent = `SCP Consensus: ${currentCount}/${maxNodes} Nodes`;
                stepIndex++;
                
                if (stepIndex >= consensusSteps.length) {
                    clearInterval(interval);
                    scpStatusElement.textContent = `SCP Consensus: ${maxNodes}/${maxNodes} Nodes âœ“`;
                    // í•©ì˜ ì™„ë£Œ í›„ ì ì‹œ í›„ ì‚¬ë¼ì§€ê²Œ
                    setTimeout(() => { scpStatusElement.style.opacity = 0; }, 5000); 
                }
            }, 500);
        }

        // [MOCK] Pi ì¸ì¦ (SDK ì œê±°)
        function piAuthenticate() {
            alert("[DEMO] Pi Network Authentication (Login) Successful!\n\nUser 'MaxUser' has been identified.");
            
            authenticatedUser = 'MaxUser';
            showMessage(`âœ“ Authenticated: ${authenticatedUser} (DEMO)`, true);
            
            document.getElementById('login_button').disabled = true;
            document.getElementById('payment_button').disabled = false;
        }

        // [MOCK] Pi ê²°ì œ ìš”ì²­ (SDK ì œê±°)
        function piRequestPayment() {
            if (!authenticatedUser) {
                showMessage('Please login first!', false);
                return;
            }

            const amount = parseFloat(document.getElementById('piAmount').value);
            const taskType = document.getElementById('taskType').value;

            if (isNaN(amount) || amount <= 0) {
                showMessage('Invalid amount!', false);
                return;
            }

            alert(`[DEMO] Pi Payment Request Sent!\nAmount: ${amount} Pi\nMemo: AI Task: ${taskType}\n\n[ACTION] The Pi Browser would normally show the payment pop-up here. Assuming success for demo.`);
            
            // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ 
            runSimulation(amount, taskType, 'DEMO-TX-ID-' + Date.now()); 
        }
        
        // ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ (ì‹¤íŒ¨ ë¡œì§ ë° AI3, ê³µê³µì„¸ 20% í¬í•¨)
        function runSimulation(amount, taskType, paymentId) {
            const scType = amount <= 2.0 ? '1st SC (Survival)' : '2nd SC (Market)';
            startSCPAnimation(scType);

            const ledger = document.getElementById('smart_contract_ledger');
            transactionID++;
            const mainID = `TX-${transactionID}`;
            
            // í•µì‹¬ ë¡œì§: ê³µê³µì„¸ 20% ê³„ì‚° ë° ë°˜ì˜
            const taxRate = 0.20;
            const taxAmount = amount * taxRate;
            const netAmount = amount - taxAmount;
            publicTaxTotal += taxAmount; 
            
            document.getElementById('public_tax_total').textContent = `Public Tax Total: ${publicTaxTotal.toFixed(4)} Ï€`;


            const subAmountBase = (netAmount / 2).toFixed(4); // ê³µê³µì„¸ ì œì™¸ëœ ê¸ˆì•¡ì„ 2ê°œë¡œ ë‚˜ëˆ”
            const sender = authenticatedUser || 'System';
            const currentTime = new Date().toLocaleTimeString();

            // íŠ¸ëœì­ì…˜ ìƒíƒœë¥¼ ê²°ì •í•˜ëŠ” í•¨ìˆ˜ (20% í™•ë¥ ë¡œ ì‹¤íŒ¨)
            function getStatus(isFinal = false) {
                if (Math.random() < 0.20) { 
                    return {
                        status: 'FAILED',
                        badgeClass: 'status-failed',
                        amountSign: '-',
                        amountColor: 'text-red-600',
                        amount: subAmountBase,
                        isSuccess: false
                    };
                }
                return {
                    status: isFinal ? 'FINALIZED' : 'SUCCESS',
                    badgeClass: 'status-success',
                    amountSign: '+',
                    amountColor: 'text-green-600',
                    amount: subAmountBase,
                    isSuccess: true
                };
            }
            
            // Main Transaction (í•­ìƒ CALLED ì„±ê³µ)
            const mainRow = `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-2 font-bold">${mainID}</td>
                    <td class="px-2 py-2">${currentTime}</td>
                    <td class="px-2 py-2">${sender}</td>
                    <td class="px-2 py-2">${scType}</td>
                    <td class="px-2 py-2 text-right font-bold">${amount.toFixed(4)} Ï€</td>
                    <td class="px-2 py-2">${taskType}</td>
                    <td class="px-2 py-2"><span class="status-badge status-success">CALLED</span></td>
                </tr>
            `;
            
            // ê³µê³µì„¸ íŠ¸ëœì­ì…˜
            const taxRow = `
                <tr class="hover:bg-gray-50 bg-yellow-50">
                    <td class="px-2 py-2">${mainID}-TAX</td>
                    <td class="px-2 py-2">${currentTime}</td>
                    <td class="px-2 py-2">System</td>
                    <td class="px-2 py-2 text-orange-600">PUBLIC TAX (20%)</td>
                    <td class="px-2 py-2 text-right text-orange-600">- ${taxAmount.toFixed(4)} Ï€</td>
                    <td class="px-2 py-2">Community Fund</td>
                    <td class="px-2 py-2"><span class="status-badge status-pending">FUNDED</span></td>
                </tr>
            `;


            // Sub Transaction 1 & 2 ìƒíƒœ ê²°ì •
            const status1 = getStatus();
            const status2 = getStatus();

            const subRow1 = `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-2">${mainID}-AI1</td>
                    <td class="px-2 py-2">${currentTime}</td>
                    <td class="px-2 py-2">AI Processor 1</td>
                    <td class="px-2 py-2">Task Processing</td>
                    <td class="px-2 py-2 text-right ${status1.amountColor}">${status1.amountSign}${status1.amount} Ï€</td>
                    <td class="px-2 py-2"> ${taskType} Execution</td>
                    <td class="px-2 py-2"><span class="status-badge ${status1.badgeClass}">${status1.status}</span></td>
                </tr>
            `;

            const subRow2 = `
                <tr class="hover:bg-gray-50">
                    <td class="px-2 py-2">${mainID}-AI2</td>
                    <td class="px-2 py-2">${currentTime}</td>
                    <td class="px-2 py-2">AI Processor 2</td>
                    <td class="px-2 py-2">Consensus Verification</td>
                    <td class="px-2 py-2 text-right ${status2.amountColor}">${status2.amountSign}${status2.amount} Ï€</td>
                    <td class="px-2 py-2">SC Finalization</td>
                    <td class="px-2 py-2"><span class="status-badge ${status2.badgeClass}">${status2.status}</span></td>
                </tr>
            `;
            
            // AI3 (ëŒ€ì²´ AI) ë¡œì§ (AI1 ë˜ëŠ” AI2 ì‹¤íŒ¨ ì‹œ ì‘ë™)
            let ai3Row = '';
            let finalMessage = 'âœ“ Transaction recorded successfully!';
            let isOverallSuccess = true;

            if (!status1.isSuccess || !status2.isSuccess) {
                 // netAmountì—ì„œ ì„±ê³µí•œ AIì—ê²Œ ì§€ê¸‰ëœ ê¸ˆì•¡ì„ ëº€ ì”ì•¡ì„ AI3ê°€ ë³´ìƒ
                 const successfulPayments = (status1.isSuccess ? parseFloat(status1.amount) : 0) + (status2.isSuccess ? parseFloat(status2.amount) : 0);
                 const compensatedAmount = netAmount - successfulPayments; 
                 
                 ai3Row = `
                    <tr class="hover:bg-gray-50 bg-red-100">
                        <td class="px-2 py-2">${mainID}-AI3</td>
                        <td class="px-2 py-2">${new Date().toLocaleTimeString()}</td>
                        <td class="px-2 py-2 font-bold text-red-700">AI Processor 3 (RETRY)</td>
                        <td class="px-2 py-2">Task Rerun/Finalization</td>
                        <td class="px-2 py-2 text-right text-red-700">+${compensatedAmount.toFixed(4)} Ï€</td>
                        <td class="px-2 py-2">COMPENSATED RERUN</td>
                        <td class="px-2 py-2"><span class="status-badge status-success">COMPLETED</span></td>
                    </tr>
                `;
                finalMessage = 'ğŸš¨ AI Task FAILED! AI 3 initiated COMPENSATED RERUN.';
                isOverallSuccess = false;
            } 

            showMessage(finalMessage, isOverallSuccess);

            // ìµœì¢…ì ìœ¼ë¡œ ë ˆì €ì— ê¸°ë¡: ë©”ì¸ -> ê³µê³µì„¸ -> AI1 -> AI2 -> (ì‹¤íŒ¨ ì‹œ) AI3
            ledger.innerHTML = mainRow + taxRow + subRow1 + subRow2 + ai3Row + ledger.innerHTML;
        }

        // CSV ë‹¤ìš´ë¡œë“œ (ê¸°ëŠ¥ ë³´ì¥ ìˆ˜ì • ì™„ë£Œ)
        function downloadLedger() {
            const table = document.getElementById('ledger_table');
            let csv = [];

            // 1. í—¤ë” ì¶”ì¶œ
            const headers = Array.from(table.querySelectorAll('thead th'))
                .map(th => th.textContent.trim());
            csv.push(headers.join(','));

            // 2. ë°ì´í„° ì¶”ì¶œ
            const rows = Array.from(table.querySelectorAll('tbody tr'));
            rows.forEach(row => {
                // ì…€ ë‚´ë¶€ì˜ í…ìŠ¤íŠ¸ë§Œ ì¶”ì¶œí•˜ê³ , ì‰¼í‘œë¥¼ í¬í•¨í•  ìˆ˜ ìˆëŠ” ë¬¸ìë¥¼ ìœ„í•´ ë”°ì˜´í‘œë¡œ ê°ìŒˆ
                const cells = Array.from(row.querySelectorAll('td'))
                    .map(td => `"${td.textContent.trim().replace(/"/g, '""')}"`); // ë”°ì˜´í‘œ ì´ìŠ¤ì¼€ì´í”„ ì²˜ë¦¬
                csv.push(cells.join(','));
            });

            const csvString = csv.join('\n');
            
            // 3. BOM(Byte Order Mark) ì¶”ê°€ ë° Blob ìƒì„± (í•œê¸€ ê¹¨ì§ ë°©ì§€)
            const BOM = "\uFEFF"; 
            const finalCsvData = BOM + csvString;
            
            const blob = new Blob([finalCsvData], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            // 4. ë‹¤ìš´ë¡œë“œ ì‹¤í–‰
            const link = document.createElement('a');
            link.href = url;
            link.download = `pi_transaction_ledger_${new Date().toISOString().slice(0, 10)}.csv`;
            
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url); // ë©”ëª¨ë¦¬ í•´ì œ

            showMessage('âœ“ Ledger downloaded!', true);
        }

        // D3 ì°¨íŠ¸ ì´ˆê¸°í™”
        function initChart() {
            const data = [1.5, 2.3, 1.8, 2.6, 3.0, 2.7, 3.2];
            const margin = { top: 20, right: 20, bottom: 40, left: 40 };
            const chartElement = document.getElementById('inflation_chart');
            
            if (!chartElement) return;
            
            const width = Math.min(chartElement.clientWidth, 800) - margin.left - margin.right;
            const height = 250 - margin.top - margin.bottom;

            const svg = d3.select('#inflation_chart').append('svg')
                .attr('width', width + margin.left + margin.right)
                .attr('height', height + margin.top + margin.bottom);

            const g = svg.append('g')
                .attr('transform', `translate(${margin.left},${margin.top})`);

            const x = d3.scaleBand()
                .domain(data.map((_, i) => `Q${i + 1}`))
                .range([0, width])
                .padding(0.3);

            const y = d3.scaleLinear()
                .domain([0, d3.max(data) + 0.5])
                .range([height, 0]);

            g.append('g')
                .attr('transform', `translate(0,${height})`)
                .call(d3.axisBottom(x));

            g.append('g')
                .call(d3.axisLeft(y).ticks(5));

            g.selectAll('.bar')
                .data(data)
                .enter().append('rect')
                .attr('class', 'bar')
                .attr('x', (d, i) => x(`Q${i + 1}`))
                .attr('y', d => y(d))
                .attr('width', x.bandwidth())
                .attr('height', d => height - y(d))
                .attr('fill', '#6366f1');
        }

        // ì´ˆê¸° ì‹¤í–‰
        window.addEventListener('DOMContentLoaded', () => {
            initChart();
            showMessage('DEMO Mode Ready!', true);
            document.getElementById('login_button').disabled = false;
        });
    </script>
</body>
</html>
